<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification Debug</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 15px; 
            background-color: var(--tg-theme-bg-color, #ffffff); 
            color: var(--tg-theme-text-color, #000000); 
        }
        #logs {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            padding: 10px;
            margin-top: 20px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
            max-height: 50vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <h3 id="status">Инициализация отладки...</h3>
    <div id="logs"></div>

    <script>
        const statusEl = document.getElementById('status');
        const logsEl = document.getElementById('logs');
        let logCounter = 1;

        function log(message) {
            console.log(message);
            const now = new Date();
            const time = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}.${now.getMilliseconds()}`;
            logsEl.innerHTML += `<div>${logCounter++}. [${time}] ${message}</div>`;
            logsEl.scrollTop = logsEl.scrollHeight; // Auto-scroll to bottom
        }

        async function runTestVerification() {
            try {
                log("Запуск функции runTestVerification.");
                
                log("Инициализация Telegram.WebApp...");
                Telegram.WebApp.ready();
                log("Telegram.WebApp.ready() выполнен. WebApp готов.");

                const urlParams = new URLSearchParams(window.location.search);
                log("Параметры URL: " + window.location.search);

                const token = urlParams.get('token');
                if (!token) {
                    throw new Error("Токен не найден в URL. Проверьте, как бот формирует кнопку.");
                }
                log("Токен найден: " + token);

                const testFingerprint = "test_fingerprint_12345";
                log("Тестовый отпечаток: " + testFingerprint);
                
                const dataToSend = {
                    token: token,
                    fingerprint: testFingerprint
                };
                log("Подготовлены данные для отправки: " + JSON.stringify(dataToSend));

                const serverUrl = 'https://bot.telegatask.ru:8443/api/v1/submit_fingerprint';
                log("Начинаю fetch-запрос на: " + serverUrl);
                statusEl.textContent = 'Отправка запроса на сервер...';

                const response = await fetch(serverUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });

                log("Fetch-запрос завершен. Статус ответа: " + response.status);
                statusEl.textContent = 'Ответ от сервера получен. Статус: ' + response.status;

                const resultText = await response.text();
                log("Тело ответа (сырой текст): " + resultText);

                const result = JSON.parse(resultText);
                log("Тело ответа (JSON): " + JSON.stringify(result));
                
                if (!response.ok) {
                    throw new Error(`Сервер ответил с ошибкой: ${result.message || 'Неизвестная ошибка сервера.'}`);
                }
                
                log("Сервер ответил успешно. Сообщение: " + (result.message || 'Тест пройден!'));
                statusEl.textContent = 'Успех!';
                Telegram.WebApp.showAlert(result.message || 'Тест пройден!');

            } catch (error) {
                log("!!! КРИТИЧЕСКАЯ ОШИБКА: " + error.message);
                log("Стек ошибки: " + (error.stack || 'Нет стека'));
                statusEl.textContent = 'Произошла ошибка!';
                Telegram.WebApp.showAlert('Отладка: Ошибка - ' + error.message);
            } finally {
                log("Выполнение завершено. Закрытие через 5 секунд.");
                setTimeout(() => {
                    log("Вызов Telegram.WebApp.close()");
                    Telegram.WebApp.close();
                }, 5000); // Даем 5 секунд на прочтение логов перед закрытием
            }
        }

        // Запускаем основную функцию
        runTestVerification();
    </script>

</body>
</html>
