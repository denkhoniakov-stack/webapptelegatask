<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Verification</title>
    <!-- 1. Скрипт для работы с Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- 2. Скрипт для сбора отпечатка устройства -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fingerprintjs2/2.1.0/fingerprint2.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; }
    </style>
</head>
<body>

    <p>Идет проверка вашего устройства...</p>

    <script>
        // Убедимся, что приложение готово к работе
        Telegram.WebApp.ready();

        // Функция для получения токена из URL
        function getTokenFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }

        // Асинхронная функция для сбора отпечатка и отправки данных
        async function runVerification() {
            const token = getTokenFromUrl();
            if (!token) {
                Telegram.WebApp.showAlert("Ошибка: токен проверки не найден.");
                Telegram.WebApp.close(); // Закрываем, если нет токена
                return;
            }

            // Получаем отпечаток устройства
            Fingerprint2.get(async function (components) {
                const values = components.map(function (component) { return component.value });
                const fingerprint = Fingerprint2.x64hash128(values.join(''), 31);

                // Готовим данные для отправки боту
                const dataToSend = {
                    token: token,
                    fingerprint: fingerprint
                };

                try {
                    // Отправляем данные на ваш сервер, где запущен бот
                    const response = await fetch('https://denkhoniakov-stack.github.io/webapptelegatask/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dataToSend)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Если все успешно, показываем сообщение и закрываемся
                        Telegram.WebApp.showAlert(result.message || 'Проверка пройдена!');
                    } else {
                        // Если сервер вернул ошибку, показываем ее
                        Telegram.WebApp.showAlert(result.message || 'Произошла ошибка проверки.');
                    }
                } catch (error) {
                    // В случае сетевой или другой ошибки
                    Telegram.WebApp.showAlert('Не удалось связаться с сервером для проверки.');
                } finally {
                    // В любом случае закрываем окно Web App после завершения
                    Telegram.WebApp.close();
                }
            });
        }

        // Запускаем проверку сразу при открытии страницы
        runVerification();
    </script>

</body>
</html>
